<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Averaging-Rechner</title>
  <style>
    :root { --bg:#0b0f14; --card:#121820; --muted:#8aa0b2; --text:#eaf2f9; --accent:#5dd0ff; }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial}
    .wrap{max-width:680px;margin:0 auto;padding:16px}
    header{display:flex;align-items:center;gap:10px;margin:8px 0 16px}
    header h1{font-size:1.2rem;margin:0}
    .card{background:var(--card);border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.35);padding:16px;margin-bottom:12px;border:1px solid rgba(255,255,255,.06)}
    label{display:block;font-size:.85rem;color:var(--muted);margin-bottom:6px}
    input,textarea{width:100%;box-sizing:border-box;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:#0e131a;color:var(--text);padding:12px;outline:none}
    textarea{min-height:88px}
    input:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(93,208,255,.15)}
    .muted{color:var(--muted);font-size:.9rem}
    .btn{width:100%;padding:14px 16px;border-radius:12px;border:0;background:var(--accent);color:#001019;font-weight:700;margin-top:8px;cursor:pointer}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .metric{background:#0f141b;border:1px solid rgba(255,255,255,.06);border-radius:14px;padding:12px}
    .metric .k{color:var(--muted);font-size:.8rem}
    .metric .v{font-size:1.05rem;font-weight:700;margin-top:2px}
    .ok{color:#6ef797}
    .bad{color:#ff7b7b}
    .footer{opacity:.7;font-size:.8rem;margin-top:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M3 3v18h18" stroke="#5dd0ff" stroke-width="2"/><path d="M5 15l4-6 4 3 4-6 3 5" stroke="#5dd0ff" stroke-width="2" fill="none"/>
      </svg>
      <h1>Averaging‑Rechner (50/50 @ Entry & Entry+0,5%)</h1>
    </header>

    <!-- Risiko (persistiert) -->
    <div class="card">
      <label>Gewünschtes Risiko in $ <span class="muted">(bleibt gespeichert, bis du es änderst)</span></label>
      <input id="risk" type="number" step="0.01" value="25" />
    </div>

    <!-- QUICK PASTE PARSER -->
    <div class="card">
      <label>Discord-/Chat‑Zeile einfügen (wir erkennen nur Entry & SL, Rest wird ignoriert)</label>
      <textarea id="paste" placeholder="z. B.: @user longed COAI at 0.4156 sl: 0.388 (1% risk)"></textarea>
      <button class="btn" id="parse">Parsen & Berechnen</button>
      <p id="parse_status" class="muted"></p>
      <p class="muted">Erkennung akzeptiert <b>sl:</b> und <b>sl;</b>. Beispiel: <code>longed jelly at 0.061579 sl; 0.05783</code></p>
    </div>

    <div class="grid">
      <div class="metric"><div class="k">Limit #1 Preis</div><div class="v" id="m_p1">–</div></div>
      <div class="metric"><div class="k">Limit #2 Preis</div><div class="v" id="m_p2">–</div></div>
      <div class="metric"><div class="k">Ø Entry (Soll)</div><div class="v" id="m_avg">–</div></div>
      <div class="metric"><div class="k">Qty #1</div><div class="v" id="m_q1">–</div></div>
      <div class="metric"><div class="k">Qty #2</div><div class="v" id="m_q2">–</div></div>
      <div class="metric"><div class="k">Ø Entry (effektiv)</div><div class="v" id="m_avg_eff">–</div></div>
    </div>

    <div class="card">
      <label>Order‑Details (zum Kopieren)</label>
      <textarea id="out" readonly></textarea>
      <p class="footer">Hinweis: Vereinfachtes Modell (keine Slippage/Funding/Partials ≠ 50/50).</p>
    </div>
  </div>

<script>
function fmt(n, d=8){ return Number(n).toFixed(d); }

// Risiko lokal persistieren
const RISK_KEY = 'averaging_risk_usd';
function loadRisk(){ try{ const v = localStorage.getItem(RISK_KEY); if(v!==null){ document.getElementById('risk').value = v; } }catch(e){} }
function saveRisk(){ try{ localStorage.setItem(RISK_KEY, String(document.getElementById('risk').value || '')); }catch(e){} }

// Core-Berechnung (ohne Gebühren/Raster): 50% @ entry, 50% @ entry*1.005
function compute(entry, stop, risk){
  const p1 = entry;
  const p2 = entry * 1.005;
  const avg = entry * 1.0025;
  const riskPerUnit = Math.max(avg - stop, 0);
  if(!(riskPerUnit>0)) return null;
  const totalQty = risk / riskPerUnit;
  const q1 = totalQty / 2;
  const q2 = totalQty / 2;
  const not1 = p1 * q1, not2 = p2 * q2;
  const avgEff = (not1 + not2) / (q1 + q2);
  return { p1, p2, avg, q1, q2, avgEff, totalQty };
}

// Parser
function normalize(raw){ return raw.replace(/\n|\r/g,' ').replace(/,/g,' ').toLowerCase(); }
function firstNumberAfter(text, anchor){
  const idx = text.indexOf(anchor);
  if(idx === -1) return null;
  for(let i=idx+anchor.length; i<text.length; i++){
    const ch = text[i];
    if((ch>='0'&&ch<='9') || ch==='.'){
      let j=i; while(j<text.length && ((text[j]>='0'&&text[j]<='9')||text[j]==='.')) j++;
      return Number(text.slice(i,j));
    }
  }
  return null;
}
function parseLine(raw){
  if(!raw) return null;
  const s = normalize(raw);
  let entry = firstNumberAfter(s, ' at ');
  if(entry===null) entry = firstNumberAfter(s, 'at ');
  let slIndex = s.indexOf(' sl');
  if(slIndex === -1) slIndex = s.indexOf(' sl:');
  if(slIndex === -1) slIndex = s.indexOf(' sl;');
  let stop = null;
  if(slIndex !== -1){
    stop = firstNumberAfter(s.slice(slIndex), 'sl');
    if(stop===null) stop = firstNumberAfter(s.slice(slIndex), 'sl:');
    if(stop===null) stop = firstNumberAfter(s.slice(slIndex), 'sl;');
  }
  if(!(entry>0 && stop>0)) return null;
  return { entry, stop };
}

function render(res){
  document.getElementById('m_p1').textContent = fmt(res.p1);
  document.getElementById('m_p2').textContent = fmt(res.p2);
  document.getElementById('m_avg').textContent = fmt(res.avg);
  document.getElementById('m_q1').textContent = fmt(res.q1);
  document.getElementById('m_q2').textContent = fmt(res.q2);
  document.getElementById('m_avg_eff').textContent = fmt(res.avgEff);
  const out = `LIMIT #1: Preis ${fmt(res.p1)}, Menge ${fmt(res.q1)}\n`+
              `LIMIT #2: Preis ${fmt(res.p2)}, Menge ${fmt(res.q2)}\n`+
              `Stop-Loss: — (aus Paste)\n`+
              `Ø Entry (Soll): ${fmt(res.avg)} | Ø Entry (effektiv): ${fmt(res.avgEff)}`;
  document.getElementById('out').value = out;
}

function handleParse(){
  saveRisk();
  const status = document.getElementById('parse_status');
  const raw = document.getElementById('paste').value;
  const parsed = parseLine(raw);
  if(!parsed){ status.textContent = 'Konnte Entry/SL nicht erkennen.'; status.className = 'muted bad'; return; }
  status.textContent = `Erkannt: Entry ${parsed.entry} · SL ${parsed.stop}`; status.className = 'muted ok';
  const risk = Number(document.getElementById('risk').value || '0');
  const res = compute(parsed.entry, parsed.stop, risk);
  if(!res){ status.textContent += ' · (Stop liegt nicht unter Ø‑Entry)'; return; }
  render(res);
}

// UX: Enter im Paste-Feld triggert sofort Parse
const pasteEl = document.getElementById('paste');
pasteEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && (e.metaKey||e.ctrlKey||!e.shiftKey)){ e.preventDefault(); handleParse(); } });

document.getElementById('parse').addEventListener('click', handleParse);

// init
window.addEventListener('load', ()=>{ loadRisk(); });
</script>
</body>
</html>
